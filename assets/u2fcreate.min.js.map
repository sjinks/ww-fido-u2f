{"version":3,"sources":["u2fcreate.js"],"names":["magic","$","document","getElementById","bind","form","spinner","querySelector","list","btn_submit","key_name","hint","showError","msg","where","node","parentNode","removeChild","insertAdjacentHTML","showSuccess","hideMessages","showSpinner","show","classList","add","setAttribute","removeAttribute","remove","registerCompleted","noitems","this","response","status","ok","row","message","wwU2F","sigs","request","value","serverError","revokeCompleted","tgt","target","tagName","toUpperCase","killRow","getElementsByTagName","length","tpl","textContent","maybeNoItems","addEventListener","e","preventDefault","reportValidity","version","challenge","u2f","register","appId","data","errorCode","errors","name","encodeURIComponent","req","XMLHttpRequest","open","ajaxurl","setRequestHeader","responseType","send","JSON","stringify","doRegister","className","indexOf","confirm","revconfirm","handle","dataset","nonce","style","float","margin","noSupport","s","createElement","u2f_api","head","appendChild"],"mappings":"AACA,SAASA,QAER,IAAIC,EAAaC,SAASC,eAAeC,KAAKF,UAC1CG,EAAaJ,EAAE,gBACfK,EAAaD,EAAKE,cAAc,YAChCC,EAAaP,EAAE,YACfQ,EAAaR,EAAE,iBACfS,EAAaT,EAAE,YACfU,EAAaV,EAAE,QAEnB,SAASW,EAAUC,EAAKC,GAEvB,IAAIC,EAAOb,SAASK,cAAc,IAAMO,EAAQ,cAChDC,GAAQA,EAAKC,WAAWC,YAAYF,GACpCd,EAAEa,GAAOI,mBAAmB,WAAY,8CAAgDL,EAAM,cAG/F,SAASM,EAAYN,EAAKC,GAEzB,IAAIC,EAAOb,SAASK,cAAc,IAAMO,EAAQ,cAChDC,GAAQA,EAAKC,WAAWC,YAAYF,GACpCd,EAAEa,GAAOI,mBAAmB,WAAY,gDAAkDL,EAAM,cAGjG,SAASO,IAER,IAAIL,EAAOb,SAASK,cAAc,sBAClCQ,GAAQA,EAAKC,WAAWC,YAAYF,IACpCA,EAAOb,SAASK,cAAc,gCACtBQ,EAAKC,WAAWC,YAAYF,GAGrC,SAASM,EAAYC,GAEhBA,GACHhB,EAAQiB,UAAUC,IAAI,aACtBf,EAAWgB,aAAa,WAAY,IACpCd,EAAKe,gBAAgB,YAGrBpB,EAAQiB,UAAUI,OAAO,aACzBlB,EAAWiB,gBAAgB,YAC3Bf,EAAKc,aAAa,SAAU,KAY9B,SAASG,IART,IAEKC,GAQJR,GAAY,GACR,OAASS,KAAKC,UAA4B,MAAhBD,KAAKE,QAK/BF,KAAKC,SAASE,KAddJ,EAAUrB,EAAKD,cAAc,iBAEhCsB,EAAQb,WAAWC,YAAYY,GAc/BrB,EAAKU,mBAAmB,YAAaY,KAAKC,SAASG,KACnDf,EAAYW,KAAKC,SAASI,QAAS,WAEnCC,MAAMC,KAAWP,KAAKC,SAASM,KAC/BD,MAAME,QAAWR,KAAKC,SAASO,QAC/B5B,EAAS6B,MAAQ,IAGjB3B,EAAUkB,KAAKC,SAASI,QAAS,WAdjCvB,EAAUwB,MAAMI,YAAa,WAsE/B,SAASC,IAEMX,KAAKY,IAAInC,cAAc,YAC7BgB,UAAUI,OAAO,aAErB,OAASG,KAAKC,UAA4B,MAAhBD,KAAKE,OAK/BF,KAAKC,SAASE,IACjBd,EAAYW,KAAKC,SAASI,QAAS,mBA5BrC,SAAiBQ,GAEhB,KAAkB,OAAXA,GAAoD,OAAjCA,EAAOC,QAAQC,eACxCF,EAASA,EAAO3B,WAGjB2B,GAAUA,EAAO3B,WAAWC,YAAY0B,GAuBvCG,CAAQhB,KAAKY,KApBf,WAEC,IAAKlC,EAAKuC,qBAAqB,MAAMC,OAAQ,CAC5C,IAAIC,EAAMhD,EAAE,aAAaiD,YACzB1C,EAAKU,mBAAmB,YAAa+B,IAiBrCE,GACAf,MAAMC,KAAOP,KAAKC,SAASM,MAG3BzB,EAAUkB,KAAKC,SAASI,QAAS,mBAXjCvB,EAAUwB,MAAMI,YAAa,mBA/B/BnC,EAAK+C,iBAAiB,SAAU,SAASC,GACxCA,EAAEC,iBACEjD,EAAKkD,mBACRlC,GAAY,GA9Bd,WAECD,IAEA,IAAIkB,EAAU,CAAC,CACdkB,QAASpB,MAAME,QAAQkB,QACvBC,UAAWrB,MAAME,QAAQmB,YAG1BC,IAAIC,SAASvB,MAAME,QAAQsB,MAAOtB,EAASF,MAAMC,KAAM,SAASwB,GAC/D,GAAIA,EAAKC,UAIR,OAFAlD,EADUwB,MAAM2B,OAAOF,EAAKC,YAAc1B,MAAM2B,OAAO,GACxC,gBACf1C,GAAY,GAIb,IAAI2C,EAAOC,mBAAmBvD,EAAS6B,OACnC2B,EAAO,IAAIC,eACfD,EAAId,iBAAiB,OAAQxB,GAC7BsC,EAAIE,KAAK,OAAQC,SACjBH,EAAII,iBAAiB,eAAgB,qCACrCJ,EAAIK,aAAe,OACnBL,EAAIM,KAAK,8BAAgCP,mBAAmBQ,KAAKC,UAAUb,IAAS,SAAWG,KAQ/FW,MA0CFzE,SAASK,cAAc,yBAAyB6C,iBAAiB,QAAS,SAASC,GAElF,IADA,IAAIV,EAASU,EAAEV,OACG,OAAXA,KAAqBA,EAAOC,SAA4C,WAAjCD,EAAOC,QAAQC,gBAA6E,IAA/CF,EAAOiC,UAAUC,QAAQ,mBACnHlC,EAASA,EAAO3B,WAGjB,GAAI2B,GAAUmC,QAAQ1C,MAAM2C,YAAa,CACxC,IAAIC,EAASrC,EAAOsC,QAAQD,OACxBE,EAASvC,EAAOsC,QAAQC,MACxBhB,EAAS,IAAIC,eACjBD,EAAIxB,IAASC,EACbuB,EAAId,iBAAiB,OAAQX,GAE7B,IAAInC,EAAUqC,EAAOpC,cAAc,YACnCD,EAAQ6E,MAAMC,MAAQ,OACtB9E,EAAQ6E,MAAME,OAAS,EACvB/E,EAAQiB,UAAUC,IAAI,aACtBJ,IAEA8C,EAAIE,KAAK,OAAQC,SACjBH,EAAII,iBAAiB,eAAgB,qCACrCJ,EAAIK,aAAe,OACnBL,EAAIM,KACD,8BACaP,mBAAmBe,GAChC,aAAeE,MAKD,oBAARxB,KAAwBA,IAAIC,UACtC/C,EAAUwB,MAAMkD,UAAW,WAI7BpF,SAASkD,iBAAiB,mBAAoB,WAC7C,GAAmB,oBAARM,KAAwBA,IAAIC,SAStC3D,YATgD,CAChD,IAAIuF,EAAIrF,SAASsF,cAAc,UAC/BD,EAAE9D,aAAa,MAAOW,MAAMqD,SAC5BF,EAAE9D,aAAa,QAAS,IACxB8D,EAAEnC,iBAAiB,OAAQpD,OAC3BuF,EAAEnC,iBAAiB,QAASpD,OAC5BE,SAASwF,KAAKC,YAAYJ","file":"u2fcreate.min.js","sourcesContent":["/** global u2f, wwU2F, ajaxurl */\nfunction magic()\n{\n\tvar $          = document.getElementById.bind(document);\n\tvar form       = $('new-key-form');\n\tvar spinner    = form.querySelector('.spinner');\n\tvar list       = $('the-list');\n\tvar btn_submit = $('submit-button');\n\tvar key_name   = $('key-name');\n\tvar hint       = $('hint');\n\n\tfunction showError(msg, where)\n\t{\n\t\tvar node = document.querySelector('#' + where + ' + .notice');\n\t\tnode && node.parentNode.removeChild(node);\n\t\t$(where).insertAdjacentHTML('afterend', '<div class=\"notice notice-error inline\"><p>' + msg + '</p></div>');\n\t}\n\n\tfunction showSuccess(msg, where)\n\t{\n\t\tvar node = document.querySelector('#' + where + ' + .notice');\n\t\tnode && node.parentNode.removeChild(node);\n\t\t$(where).insertAdjacentHTML('afterend', '<div class=\"notice notice-success inline\"><p>' + msg + '</p></div>');\n\t}\n\n\tfunction hideMessages()\n\t{\n\t\tvar node = document.querySelector('#new-key + .notice');\n\t\tnode && node.parentNode.removeChild(node);\n\t\tnode = document.querySelector('#registered-keys + .notice');\n\t\tnode && node.parentNode.removeChild(node);\n\t}\n\n\tfunction showSpinner(show)\n\t{\n\t\tif (show) {\n\t\t\tspinner.classList.add('is-active');\n\t\t\tbtn_submit.setAttribute('disabled', '');\n\t\t\thint.removeAttribute('hidden');\n\t\t}\n\t\telse {\n\t\t\tspinner.classList.remove('is-active');\n\t\t\tbtn_submit.removeAttribute('disabled');\n\t\t\thint.setAttribute('hidden', '');\n\t\t}\n\t}\n\n\tfunction haveNewItems()\n\t{\n\t\tvar noitems = list.querySelector('tr.no-items')\n\t\tif (noitems) {\n\t\t\tnoitems.parentNode.removeChild(noitems);\n\t\t}\n\t}\n\n\tfunction registerCompleted()\n\t{\n\t\tshowSpinner(false);\n\t\tif (null === this.response || this.status !== 200) {\n\t\t\tshowError(wwU2F.serverError, 'new-key');\n\t\t\treturn;\n\t\t}\n\n\t\tif (this.response.ok) {\n\t\t\thaveNewItems();\n\t\t\tlist.insertAdjacentHTML('beforeend', this.response.row);\n\t\t\tshowSuccess(this.response.message, 'new-key');\n\n\t\t\twwU2F.sigs     = this.response.sigs;\n\t\t\twwU2F.request  = this.response.request;\n\t\t\tkey_name.value = '';\n\t\t}\n\t\telse {\n\t\t\tshowError(this.response.message, 'new-key');\n\t\t}\n\t}\n\n\tfunction doRegister()\n\t{\n\t\thideMessages();\n\n\t\tvar request = [{\n\t\t\tversion: wwU2F.request.version,\n\t\t\tchallenge: wwU2F.request.challenge\n\t\t}];\n\n\t\tu2f.register(wwU2F.request.appId, request, wwU2F.sigs, function(data) {\n\t\t\tif (data.errorCode) {\n\t\t\t\tvar err = wwU2F.errors[data.errorCode] || wwU2F.errors[1];\n\t\t\t\tshowError(err, 'new-key');\n\t\t\t\tshowSpinner(false);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tvar name = encodeURIComponent(key_name.value);\n\t\t\tvar req  = new XMLHttpRequest();\n\t\t\treq.addEventListener('load', registerCompleted);\n\t\t\treq.open('POST', ajaxurl);\n\t\t\treq.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');\n\t\t\treq.responseType = 'json';\n\t\t\treq.send('action=wwu2f_register&data=' + encodeURIComponent(JSON.stringify(data)) + '&name=' + name);\n\t\t});\n\t}\n\n\tform.addEventListener('submit', function(e) {\n\t\te.preventDefault();\n\t\tif (form.reportValidity()) {\n\t\t\tshowSpinner(true);\n\t\t\tdoRegister();\n\t\t}\n\t});\n\n\tfunction killRow(target)\n\t{\n\t\twhile (target !== null && target.tagName.toUpperCase() !== 'TR') {\n\t\t\ttarget = target.parentNode;\n\t\t}\n\n\t\ttarget && target.parentNode.removeChild(target);\n\t}\n\n\tfunction maybeNoItems()\n\t{\n\t\tif (!list.getElementsByTagName('tr').length) {\n\t\t\tvar tpl = $('tpl-empty').textContent;\n\t\t\tlist.insertAdjacentHTML('beforeend', tpl);\n\t\t}\n\t}\n\n\tfunction revokeCompleted()\n\t{\n\t\tvar spinner = this.tgt.querySelector('.spinner');\n\t\tspinner.classList.remove('is-active');\n\n\t\tif (null === this.response || this.status !== 200) {\n\t\t\tshowError(wwU2F.serverError, 'registered-keys');\n\t\t\treturn;\n\t\t}\n\n\t\tif (this.response.ok) {\n\t\t\tshowSuccess(this.response.message, 'registered-keys');\n\t\t\tkillRow(this.tgt);\n\t\t\tmaybeNoItems();\n\t\t\twwU2F.sigs = this.response.sigs;\n\t\t}\n\t\telse {\n\t\t\tshowError(this.response.message, 'registered-keys');\n\t\t}\n\t}\n\n\tdocument.querySelector('table.widefat > tbody').addEventListener('click', function(e) {\n\t\tvar target = e.target;\n\t\twhile (target !== null && (!target.tagName || target.tagName.toUpperCase() !== 'BUTTON' || target.className.indexOf('revoke-button') === -1)) {\n\t\t\ttarget = target.parentNode;\n\t\t}\n\n\t\tif (target && confirm(wwU2F.revconfirm)) {\n\t\t\tvar handle = target.dataset.handle;\n\t\t\tvar nonce  = target.dataset.nonce;\n\t\t\tvar req    = new XMLHttpRequest();\n\t\t\treq.tgt    = target;\n\t\t\treq.addEventListener('load', revokeCompleted);\n\n\t\t\tvar spinner = target.querySelector('.spinner');\n\t\t\tspinner.style.float = 'none';\n\t\t\tspinner.style.margin = 0;\n\t\t\tspinner.classList.add('is-active');\n\t\t\thideMessages();\n\n\t\t\treq.open('POST', ajaxurl);\n\t\t\treq.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');\n\t\t\treq.responseType = 'json';\n\t\t\treq.send(\n\t\t\t\t  'action=wwu2f_revoke'\n\t\t\t\t+ '&handle=' + encodeURIComponent(handle) \n\t\t\t\t+ '&_wpnonce=' + nonce\n\t\t\t);\n\t\t}\n\t});\n\n\tif (typeof u2f === 'undefined' || !u2f.register) {\n\t\tshowError(wwU2F.noSupport, 'new-key');\n\t}\n}\n\ndocument.addEventListener('DOMContentLoaded', function() {\n\tif (typeof u2f === 'undefined' || !u2f.register) {\n\t\tvar s = document.createElement('script');\n\t\ts.setAttribute('src', wwU2F.u2f_api);\n\t\ts.setAttribute('async', '');\n\t\ts.addEventListener('load', magic);\n\t\ts.addEventListener('error', magic);\n\t\tdocument.head.appendChild(s);\n\t}\n\telse {\n\t\tmagic();\n\t}\n});\n"]}