{"version":3,"sources":["u2fcreate.js"],"names":["magic","form","document","getElementById","spinner","querySelector","list","btn_submit","key_name","hint","showError","msg","where","node","parentNode","removeChild","insertAdjacentHTML","showSuccess","showSpinner","show","classList","add","setAttribute","removeAttribute","remove","registerCompleted","this","response","status","ok","noitems","row","message","wwU2F","sigs","request","value","serverError","addEventListener","e","preventDefault","reportValidity","version","challenge","u2f","register","appId","data","errorCode","code","errors","name","encodeURIComponent","req","XMLHttpRequest","open","ajax_url","setRequestHeader","responseType","send","JSON","stringify","doRegister","target","tagName","toUpperCase","className","indexOf","confirm","revconfirm","handle","dataset","nonce","getElementsByTagName","length","tpl","textContent","noSupport","s","createElement","u2f_api","head","appendChild"],"mappings":"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","file":"u2fcreate.min.js","sourcesContent":["/** global u2f, wwU2F */\nfunction magic() {\n\tvar form       = document.getElementById('new-key-form');\n\tvar spinner    = form.querySelector('.spinner');\n\tvar list       = document.getElementById('the-list');\n\tvar btn_submit = document.getElementById('submit-button');\n\tvar key_name   = document.getElementById('key-name');\n\tvar hint       = document.getElementById('hint');\n\n\tfunction showError(msg, where)\n\t{\n\t\tvar node = document.querySelector('#' + where + ' + .notice');\n\t\tnode && node.parentNode.removeChild(node);\n\t\tdocument.getElementById(where).insertAdjacentHTML('afterend', '<div class=\"notice notice-error inline\"><p>' + msg + '</p></div>');\n\t}\n\n\tfunction showSuccess(msg, where)\n\t{\n\t\tvar node = document.querySelector('#' + where + ' + .notice');\n\t\tnode && node.parentNode.removeChild(node);\n\t\tdocument.getElementById(where).insertAdjacentHTML('afterend', '<div class=\"notice notice-success inline\"><p>' + msg + '</p></div>');\n\t}\n\n\tfunction showSpinner(show)\n\t{\n\t\tif (show) {\n\t\t\tspinner.classList.add('is-active');\n\t\t\tbtn_submit.setAttribute('disabled', '');\n\t\t\thint.removeAttribute('hidden');\n\t\t}\n\t\telse {\n\t\t\tspinner.classList.remove('is-active');\n\t\t\tbtn_submit.removeAttribute('disabled');\n\t\t\thint.setAttribute('hidden', '');\n\t\t}\n\t}\n\n\tfunction registerCompleted()\n\t{\n\t\tshowSpinner(false);\n\t\tif (null === this.response || this.status !== 200) {\n\t\t\tshowError(wwU2F.serverError, 'new-key');\n\t\t\treturn;\n\t\t}\n\n\t\tif (this.response.ok) {\n\t\t\tvar noitems = list.querySelector('tr.no-items')\n\t\t\tif (noitems) {\n\t\t\t\tnoitems.parentNode.removeChild(noitems);\n\t\t\t}\n\n\t\t\tlist.insertAdjacentHTML('beforeend', this.response.row);\n\t\t\tshowSuccess(this.response.message, 'new-key');\n\n\t\t\twwU2F.sigs     = this.response.sigs;\n\t\t\twwU2F.request  = this.response.request;\n\t\t\tkey_name.value = '';\n\t\t}\n\t\telse {\n\t\t\tshowError(this.response.message, 'new-key');\n\t\t}\n\t}\n\n\tfunction doRegister()\n\t{\n\t\tvar node = document.querySelector('#new-key + .notice');\n\t\tnode && node.parentNode.removeChild(node);\n\t\tnode = document.querySelector('#registered-keys + .notice');\n\t\tnode && node.parentNode.removeChild(node);\n\n\t\tvar request = [{\n\t\t\tversion: wwU2F.request.version,\n\t\t\tchallenge: wwU2F.request.challenge\n\t\t}];\n\n\t\tu2f.register(wwU2F.request.appId, request, wwU2F.sigs, function(data) {\n\t\t\tif (data.errorCode) {\n\t\t\t\tvar code = wwU2F.errors[data.errorCode] || 1;\n\t\t\t\tshowError(wwU2F.errors[code], 'new-key');\n\t\t\t\tshowSpinner(false);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tvar name = encodeURIComponent(key_name.value);\n\t\t\tvar req  = new XMLHttpRequest();\n\t\t\treq.addEventListener('load', registerCompleted);\n\t\t\treq.open('POST', wwU2F.ajax_url);\n\t\t\treq.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');\n\t\t\treq.responseType = 'json';\n\t\t\treq.send('action=wwu2f_register&data=' + encodeURIComponent(JSON.stringify(data)) + '&name=' + name);\n\t\t});\n\t}\n\n\tform.addEventListener('submit', function(e) {\n\t\te.preventDefault();\n\t\tif (form.reportValidity()) {\n\t\t\tshowSpinner(true);\n\t\t\tdoRegister();\n\t\t}\n\t});\n\n\tdocument.querySelector('table.widefat > tbody').addEventListener('click', function(e) {\n\t\tvar target = e.target;\n\t\twhile (target !== null && target.tagName.toUpperCase() !== 'BUTTON' && target.className.indexOf('revoke-button') !== -1) {\n\t\t\ttarget = target.parentNode;\n\t\t}\n\n\t\tif (target && confirm(wwU2F.revconfirm)) {\n\t\t\tvar handle = target.dataset.handle;\n\t\t\tvar nonce  = target.dataset.nonce;\n\t\t\tvar req    = new XMLHttpRequest();\n\t\t\treq.addEventListener('load', function() {\n\t\t\t\tif (null === this.response || this.status !== 200) {\n\t\t\t\t\tshowError(wwU2F.serverError, 'registered-keys');\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tif (this.response.ok) {\n\t\t\t\t\tshowSuccess(this.response.message, 'registered-keys');\n\t\t\t\t\twhile (target !== null && target.tagName.toUpperCase() !== 'TR') {\n\t\t\t\t\t\ttarget = target.parentNode;\n\t\t\t\t\t}\n\n\t\t\t\t\ttarget && target.parentNode.removeChild(target);\n\n\t\t\t\t\tif (!list.getElementsByTagName('tr').length) {\n\t\t\t\t\t\tvar tpl = document.getElementById('tpl-empty').textContent;\n\t\t\t\t\t\tlist.insertAdjacentHTML('beforeend', tpl);\n\t\t\t\t\t}\n\n\t\t\t\t\twwU2F.sigs = this.response.sigs;\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tshowError(this.response.message, 'registered-keys');\n\t\t\t\t}\n\t\t\t});\n\n\t\t\treq.open('POST', wwU2F.ajax_url);\n\t\t\treq.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');\n\t\t\treq.responseType = 'json';\n\t\t\treq.send(\n\t\t\t\t  'action=wwu2f_revoke'\n\t\t\t\t+ '&handle=' + encodeURIComponent(handle) \n\t\t\t\t+ '&_wpnonce=' + nonce\n\t\t\t);\n\t\t}\n\t});\n\n\tif (typeof u2f === 'undefined' || !u2f.register) {\n\t\tshowError(wwU2F.noSupport, 'new-key');\n\t}\n}\n\ndocument.addEventListener('DOMContentLoaded', function() {\n\tif (typeof u2f === 'undefined' || !u2f.register) {\n\t\tvar s = document.createElement('script');\n\t\ts.setAttribute('src', wwU2F.u2f_api);\n\t\ts.setAttribute('async', '');\n\t\ts.addEventListener('load', magic);\n\t\ts.addEventListener('error', magic);\n\t\tdocument.head.appendChild(s);\n\t}\n\telse {\n\t\tmagic();\n\t}\n});\n"]}