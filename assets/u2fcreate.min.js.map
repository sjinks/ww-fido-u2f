{"version":3,"sources":["u2fcreate.js"],"names":["magic","showError","msg","where","node","document","querySelector","parentNode","removeChild","getElementById","insertAdjacentHTML","showSuccess","showSpinner","show","spinner","classList","add","btn_submit","setAttribute","hint","removeAttribute","remove","registerCompleted","this","response","status","ok","noitems","list","row","message","wwU2F","sigs","request","key_name","value","serverError","form","addEventListener","e","preventDefault","reportValidity","version","challenge","u2f","register","appId","data","errorCode","errors","name","encodeURIComponent","req","XMLHttpRequest","open","ajax_url","setRequestHeader","responseType","send","JSON","stringify","doRegister","target","tagName","toUpperCase","className","indexOf","confirm","revconfirm","handle","dataset","nonce","getElementsByTagName","length","tpl","textContent","noSupport","s","createElement","u2f_api","head","appendChild"],"mappings":"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","file":"u2fcreate.min.js","sourcesContent":["/** global u2f, wwU2F */\nfunction magic() {\n\tvar form       = document.getElementById('new-key-form');\n\tvar spinner    = form.querySelector('.spinner');\n\tvar list       = document.getElementById('the-list');\n\tvar btn_submit = document.getElementById('submit-button');\n\tvar key_name   = document.getElementById('key-name');\n\tvar hint       = document.getElementById('hint');\n\n\tfunction showError(msg, where)\n\t{\n\t\tvar node = document.querySelector('#' + where + ' + .notice');\n\t\tnode && node.parentNode.removeChild(node);\n\t\tdocument.getElementById(where).insertAdjacentHTML('afterend', '<div class=\"notice notice-error inline\"><p>' + msg + '</p></div>');\n\t}\n\n\tfunction showSuccess(msg, where)\n\t{\n\t\tvar node = document.querySelector('#' + where + ' + .notice');\n\t\tnode && node.parentNode.removeChild(node);\n\t\tdocument.getElementById(where).insertAdjacentHTML('afterend', '<div class=\"notice notice-success inline\"><p>' + msg + '</p></div>');\n\t}\n\n\tfunction showSpinner(show)\n\t{\n\t\tif (show) {\n\t\t\tspinner.classList.add('is-active');\n\t\t\tbtn_submit.setAttribute('disabled', '');\n\t\t\thint.removeAttribute('hidden');\n\t\t}\n\t\telse {\n\t\t\tspinner.classList.remove('is-active');\n\t\t\tbtn_submit.removeAttribute('disabled');\n\t\t\thint.setAttribute('hidden', '');\n\t\t}\n\t}\n\n\tfunction registerCompleted()\n\t{\n\t\tshowSpinner(false);\n\t\tif (null === this.response || this.status !== 200) {\n\t\t\tshowError(wwU2F.serverError, 'new-key');\n\t\t\treturn;\n\t\t}\n\n\t\tif (this.response.ok) {\n\t\t\tvar noitems = list.querySelector('tr.no-items')\n\t\t\tif (noitems) {\n\t\t\t\tnoitems.parentNode.removeChild(noitems);\n\t\t\t}\n\n\t\t\tlist.insertAdjacentHTML('beforeend', this.response.row);\n\t\t\tshowSuccess(this.response.message, 'new-key');\n\n\t\t\twwU2F.sigs     = this.response.sigs;\n\t\t\twwU2F.request  = this.response.request;\n\t\t\tkey_name.value = '';\n\t\t}\n\t\telse {\n\t\t\tshowError(this.response.message, 'new-key');\n\t\t}\n\t}\n\n\tfunction doRegister()\n\t{\n\t\tvar node = document.querySelector('#new-key + .notice');\n\t\tnode && node.parentNode.removeChild(node);\n\t\tnode = document.querySelector('#registered-keys + .notice');\n\t\tnode && node.parentNode.removeChild(node);\n\n\t\tvar request = [{\n\t\t\tversion: wwU2F.request.version,\n\t\t\tchallenge: wwU2F.request.challenge\n\t\t}];\n\n\t\tu2f.register(wwU2F.request.appId, request, wwU2F.sigs, function(data) {\n\t\t\tif (data.errorCode) {\n\t\t\t\tvar code = wwU2F.errors[data.errorCode] || 1;\n\t\t\t\tshowError(wwU2F.errors[data.errorCode], 'new-key');\n\t\t\t\tshowSpinner(false);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tvar name = encodeURIComponent(key_name.value);\n\t\t\tvar req  = new XMLHttpRequest();\n\t\t\treq.addEventListener('load', registerCompleted);\n\t\t\treq.open('POST', wwU2F.ajax_url);\n\t\t\treq.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');\n\t\t\treq.responseType = 'json';\n\t\t\treq.send('action=wwu2f_register&data=' + encodeURIComponent(JSON.stringify(data)) + '&name=' + name);\n\t\t});\n\t}\n\n\tform.addEventListener('submit', function(e) {\n\t\te.preventDefault();\n\t\tif (form.reportValidity()) {\n\t\t\tshowSpinner(true);\n\t\t\tdoRegister();\n\t\t}\n\t});\n\n\tdocument.querySelector('table.widefat > tbody').addEventListener('click', function(e) {\n\t\tvar target = e.target;\n\t\twhile (target !== null && target.tagName.toUpperCase() !== 'BUTTON' && target.className.indexOf('revoke-button') !== -1) {\n\t\t\ttarget = target.parentNode;\n\t\t}\n\n\t\tif (target && confirm(wwU2F.revconfirm)) {\n\t\t\tvar handle = target.dataset.handle;\n\t\t\tvar nonce  = target.dataset.nonce;\n\t\t\tvar req    = new XMLHttpRequest();\n\t\t\treq.addEventListener('load', function() {\n\t\t\t\tif (null === this.response || this.status !== 200) {\n\t\t\t\t\tshowError(wwU2F.serverError, 'registered-keys');\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tif (this.response.ok) {\n\t\t\t\t\tshowSuccess(this.response.message, 'registered-keys');\n\t\t\t\t\twhile (target !== null && target.tagName.toUpperCase() !== 'TR') {\n\t\t\t\t\t\ttarget = target.parentNode;\n\t\t\t\t\t}\n\n\t\t\t\t\ttarget && target.parentNode.removeChild(target);\n\n\t\t\t\t\tif (!list.getElementsByTagName('tr').length) {\n\t\t\t\t\t\tvar tpl = document.getElementById('tpl-empty').textContent;\n\t\t\t\t\t\tlist.insertAdjacentHTML('beforeend', tpl);\n\t\t\t\t\t}\n\n\t\t\t\t\twwU2F.sigs = this.response.sigs;\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tshowError(this.response.message, 'registered-keys');\n\t\t\t\t}\n\t\t\t});\n\n\t\t\treq.open('POST', wwU2F.ajax_url);\n\t\t\treq.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');\n\t\t\treq.responseType = 'json';\n\t\t\treq.send(\n\t\t\t\t  'action=wwu2f_revoke'\n\t\t\t\t+ '&handle=' + encodeURIComponent(handle) \n\t\t\t\t+ '&_wpnonce=' + nonce\n\t\t\t);\n\t\t}\n\t});\n\n\tif (typeof u2f === 'undefined' || !u2f.register) {\n\t\tshowError(wwU2F.noSupport, 'new-key');\n\t}\n}\n\ndocument.addEventListener('DOMContentLoaded', function() {\n\tif (typeof u2f === 'undefined' || !u2f.register) {\n\t\tvar s = document.createElement('script');\n\t\ts.setAttribute('src', wwU2F.u2f_api);\n\t\ts.setAttribute('async', '');\n\t\ts.addEventListener('load', magic);\n\t\ts.addEventListener('error', magic);\n\t\tdocument.head.appendChild(s);\n\t}\n\telse {\n\t\tmagic();\n\t}\n});\n"]}