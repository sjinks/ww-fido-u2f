{"version":3,"sources":["u2fcreate.js"],"names":["magic","form","document","getElementById","spinner","querySelector","list","btn_submit","key_name","hint","showError","msg","where","node","parentNode","removeChild","insertAdjacentHTML","showSuccess","showSpinner","show","classList","add","setAttribute","removeAttribute","remove","registerCompleted","noitems","this","response","status","ok","row","message","wwU2F","sigs","request","value","serverError","revokeCompleted","target","tagName","toUpperCase","killRow","tgt","getElementsByTagName","length","tpl","textContent","maybeNoItems","addEventListener","e","preventDefault","reportValidity","version","challenge","u2f","register","appId","data","errorCode","code","errors","name","encodeURIComponent","req","XMLHttpRequest","open","ajaxurl","setRequestHeader","responseType","send","JSON","stringify","doRegister","className","indexOf","confirm","revconfirm","handle","dataset","nonce","noSupport","s","createElement","u2f_api","head","appendChild"],"mappings":"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","file":"u2fcreate.min.js","sourcesContent":["/** global u2f, wwU2F, ajaxurl */\nfunction magic() {\n\tvar form       = document.getElementById('new-key-form');\n\tvar spinner    = form.querySelector('.spinner');\n\tvar list       = document.getElementById('the-list');\n\tvar btn_submit = document.getElementById('submit-button');\n\tvar key_name   = document.getElementById('key-name');\n\tvar hint       = document.getElementById('hint');\n\n\tfunction showError(msg, where)\n\t{\n\t\tvar node = document.querySelector('#' + where + ' + .notice');\n\t\tnode && node.parentNode.removeChild(node);\n\t\tdocument.getElementById(where).insertAdjacentHTML('afterend', '<div class=\"notice notice-error inline\"><p>' + msg + '</p></div>');\n\t}\n\n\tfunction showSuccess(msg, where)\n\t{\n\t\tvar node = document.querySelector('#' + where + ' + .notice');\n\t\tnode && node.parentNode.removeChild(node);\n\t\tdocument.getElementById(where).insertAdjacentHTML('afterend', '<div class=\"notice notice-success inline\"><p>' + msg + '</p></div>');\n\t}\n\n\tfunction showSpinner(show)\n\t{\n\t\tif (show) {\n\t\t\tspinner.classList.add('is-active');\n\t\t\tbtn_submit.setAttribute('disabled', '');\n\t\t\thint.removeAttribute('hidden');\n\t\t}\n\t\telse {\n\t\t\tspinner.classList.remove('is-active');\n\t\t\tbtn_submit.removeAttribute('disabled');\n\t\t\thint.setAttribute('hidden', '');\n\t\t}\n\t}\n\n\tfunction haveNewItems()\n\t{\n\t\tvar noitems = list.querySelector('tr.no-items')\n\t\tif (noitems) {\n\t\t\tnoitems.parentNode.removeChild(noitems);\n\t\t}\n\t}\n\n\tfunction registerCompleted()\n\t{\n\t\tshowSpinner(false);\n\t\tif (null === this.response || this.status !== 200) {\n\t\t\tshowError(wwU2F.serverError, 'new-key');\n\t\t\treturn;\n\t\t}\n\n\t\tif (this.response.ok) {\n\t\t\thaveNewItems();\n\t\t\tlist.insertAdjacentHTML('beforeend', this.response.row);\n\t\t\tshowSuccess(this.response.message, 'new-key');\n\n\t\t\twwU2F.sigs     = this.response.sigs;\n\t\t\twwU2F.request  = this.response.request;\n\t\t\tkey_name.value = '';\n\t\t}\n\t\telse {\n\t\t\tshowError(this.response.message, 'new-key');\n\t\t}\n\t}\n\n\tfunction doRegister()\n\t{\n\t\tvar node = document.querySelector('#new-key + .notice');\n\t\tnode && node.parentNode.removeChild(node);\n\t\tnode = document.querySelector('#registered-keys + .notice');\n\t\tnode && node.parentNode.removeChild(node);\n\n\t\tvar request = [{\n\t\t\tversion: wwU2F.request.version,\n\t\t\tchallenge: wwU2F.request.challenge\n\t\t}];\n\n\t\tu2f.register(wwU2F.request.appId, request, wwU2F.sigs, function(data) {\n\t\t\tif (data.errorCode) {\n\t\t\t\tvar code = wwU2F.errors[data.errorCode] || 1;\n\t\t\t\tshowError(wwU2F.errors[code], 'new-key');\n\t\t\t\tshowSpinner(false);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tvar name = encodeURIComponent(key_name.value);\n\t\t\tvar req  = new XMLHttpRequest();\n\t\t\treq.addEventListener('load', registerCompleted);\n\t\t\treq.open('POST', ajaxurl);\n\t\t\treq.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');\n\t\t\treq.responseType = 'json';\n\t\t\treq.send('action=wwu2f_register&data=' + encodeURIComponent(JSON.stringify(data)) + '&name=' + name);\n\t\t});\n\t}\n\n\tform.addEventListener('submit', function(e) {\n\t\te.preventDefault();\n\t\tif (form.reportValidity()) {\n\t\t\tshowSpinner(true);\n\t\t\tdoRegister();\n\t\t}\n\t});\n\n\tfunction killRow(target)\n\t{\n\t\twhile (target !== null && target.tagName.toUpperCase() !== 'TR') {\n\t\t\ttarget = target.parentNode;\n\t\t}\n\n\t\ttarget && target.parentNode.removeChild(target);\n\t}\n\n\tfunction maybeNoItems()\n\t{\n\t\tif (!list.getElementsByTagName('tr').length) {\n\t\t\tvar tpl = document.getElementById('tpl-empty').textContent;\n\t\t\tlist.insertAdjacentHTML('beforeend', tpl);\n\t\t}\n\t}\n\t\n\tfunction revokeCompleted()\n\t{\n\t\tif (null === this.response || this.status !== 200) {\n\t\t\tshowError(wwU2F.serverError, 'registered-keys');\n\t\t\treturn;\n\t\t}\n\n\t\tif (this.response.ok) {\n\t\t\tshowSuccess(this.response.message, 'registered-keys');\n\t\t\tkillRow(this.tgt);\n\t\t\tmaybeNoItems();\n\t\t\twwU2F.sigs = this.response.sigs;\n\t\t}\n\t\telse {\n\t\t\tshowError(this.response.message, 'registered-keys');\n\t\t}\n\t}\n\t\n\tdocument.querySelector('table.widefat > tbody').addEventListener('click', function(e) {\n\t\tvar target = e.target;\n\t\twhile (target !== null && (!target.tagName || target.tagName.toUpperCase() !== 'BUTTON' || target.className.indexOf('revoke-button') === -1)) {\n\t\t\ttarget = target.parentNode;\n\t\t}\n\n\t\tif (target && confirm(wwU2F.revconfirm)) {\n\t\t\tvar handle = target.dataset.handle;\n\t\t\tvar nonce  = target.dataset.nonce;\n\t\t\tvar req    = new XMLHttpRequest();\n\t\t\treq.tgt    = target;\n\t\t\treq.addEventListener('load', revokeCompleted);\n\n\t\t\treq.open('POST', ajaxurl);\n\t\t\treq.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');\n\t\t\treq.responseType = 'json';\n\t\t\treq.send(\n\t\t\t\t  'action=wwu2f_revoke'\n\t\t\t\t+ '&handle=' + encodeURIComponent(handle) \n\t\t\t\t+ '&_wpnonce=' + nonce\n\t\t\t);\n\t\t}\n\t});\n\n\tif (typeof u2f === 'undefined' || !u2f.register) {\n\t\tshowError(wwU2F.noSupport, 'new-key');\n\t}\n}\n\ndocument.addEventListener('DOMContentLoaded', function() {\n\tif (typeof u2f === 'undefined' || !u2f.register) {\n\t\tvar s = document.createElement('script');\n\t\ts.setAttribute('src', wwU2F.u2f_api);\n\t\ts.setAttribute('async', '');\n\t\ts.addEventListener('load', magic);\n\t\ts.addEventListener('error', magic);\n\t\tdocument.head.appendChild(s);\n\t}\n\telse {\n\t\tmagic();\n\t}\n});\n"]}